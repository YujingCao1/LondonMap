<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0">
    <title>Restaurants in London UK</title>
    <script src='http://d3js.org/d3.v3.min.js'></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script src="js/colorbrewer.js"></script>

    <link rel="stylesheet" href="LondonEconomics.css"> 
</head>
<body>
    <div id="controls" class="nicebox">
        <div>
            <select id="census-variable">
                <option value = JOBS_DENSI>Job Density</option>
                <option value = MedWklyPay>Median Weekly Pay</option>
                <option value = SQKM>SQKM</option>
                <option value = MdWrkPlcPa>MdWrkPlcPa</option>
            </select>
        </div>
        <div id="legend">
            <div id="census-min" style="">min</div>
            <div class="color-key"><span id="data-caret">&#x25c6;</span></div>
            <div id="census-max">max</div>
        </div>
    </div>
    <div id="data-box", class="nicebox">
        <label id="data-label" for="data-value"></label>
        <span id="data-value"></span>
    </div>
    <div id="map"></div>
    <script type="text/javascript">
        var map;
        var censusMin = Number.MAX_VALUE, censusMax = -Number.MAX_VALUE;
        var optionsAttr = document.getElementById('census-variable'); // Show the selected one

        // Create a Google Map
        function myMap() {
            
            var json = "Economics.json";
            var mapCanvas = document.getElementById('map');
            var myCenter  = new google.maps.LatLng(51.5074,-0.1278);
            var mapOptions = {
                center: myCenter,
                zoom: 10
            };

            map = new google.maps.Map(mapCanvas, mapOptions);

            // Hoover to Highlight Selected City
            map.data.addListener('mouseover', mouseInToRegion);
            // Remove the Style
            map.data.addListener('mouseout', mouseOutOfRegion);
            // Set Up Dropdown
            google.maps.event.addDomListener(optionsAttr, 'change', function(){
                clearData();
                loadData(optionsAttr.options[optionsAttr.selectedIndex].value);
            });

            google.maps.event.addDomListener(optionsAttr, 'change', function(){
                var MinValue;
                var MaxValue;
                var attribution = optionsAttr.options[optionsAttr.selectedIndex].value;
                var attr_value = [];
                var colorFill = [];

                d3.json(json, function(error, json){
                    data = json;

                    for (i=0 ; i<json.features.length; i++){
                        attr_value[i] = json.features[i].properties[attribution];
                    }

                    MinValue = d3.min(attr_value);
                    MaxValue = d3.max(attr_value);
                });

                    map.data.setStyle(function(feature){
                    var low = [5, 69, 54];
                    var high = [151, 83, 34];
                    var delta = (feature.getProperty(attribution) - MinValue)/ (MaxValue - MinValue);
                    for (var i = 0; i < 3; i++){
                        colorFill[i] = (high[i] - low[i]) * delta + low[i];
                    }

                    return ({
                        fillColor: 'hsl(' + colorFill[0] + ',' + colorFill[1] + '%,' + colorFill[2] + '%)',
                        strokeWeight: 1.2,
                        fillOpacity: 0.8,
                        strokeColor: '#fff',
                        visible: true

                    })
                });
            })
            // Get Lat and Lng
            google.maps.event.addListener(map, 'click', function (event) {
                   displayCoordinates(event.latLng);               
                });
            // Load the Map
            loadMapShapes();
        }

        // Load Map
        function loadMapShapes(){
            map.data.loadGeoJson('Economics.json');
            google.maps.event.trigger(document.getElementById('census-variable'), 'change');

        }

        // Load Data
        function loadData(d){
            var json = "Economics.json";

            d3.json(json, function(error, json){
                data = json;

                for (var i = 0; i < json.features.length; i++) {

                    var censusVariable = json.features[i].properties[d];
                    var cityID = json.features[i].properties.PROV3NAME;

                    // Keep Track of Min and Max Values
                    if (censusVariable < censusMin){
                        censusMin = censusVariable;
                    }

                    if (censusVariable > censusMax){
                        censusMax = censusVariable;
                    }

                    // Update and Display the legend

                    document.getElementById('census-max').textContent = censusMax.toLocaleString();
                    document.getElementById('census-min').textContent = censusMin.toLocaleString();

                }
            });
        }

        // Remove Data
        function clearData() {
            censusMin = Number.MAX_VALUE;
            censusMax = -Number.MAX_VALUE;

            document.getElementById('data-box').style.display = 'none';
            document.getElementById('data-caret').style.display = 'none';
        }
        
        // Retrieve Latitudes and Longitudes
        function displayCoordinates(pnt) {
          var lat = pnt.lat();
          lat = lat.toFixed(4);
          var lng = pnt.lng();
          lng = lng.toFixed(4);
          console.log("lat: "+lat+ " lng: "+lng);
        }

        // Event Mouseover
        function mouseInToRegion(e){
            map.data.revertStyle();
            var variable = optionsAttr.value;
            var percent = (e.feature.getProperty(variable) - censusMin) /(censusMax - censusMin) * 100;

          // update the label
            document.getElementById('data-label').textContent = e.feature.getProperty('PROV3NAME');
            document.getElementById('data-value').textContent = e.feature.getProperty(variable).toLocaleString();
            document.getElementById('data-box').style.display = 'block';
            document.getElementById('data-caret').style.display = 'block';
            document.getElementById('data-caret').style.paddingLeft = percent + '%';

            map.data.overrideStyle(e.feature, {strokeWeight: 3, zIndex: 10})
        }

        // Event Mouseout
        function mouseOutOfRegion(e){
           map.data.revertStyle();
        }

        // Style Function
        function styleFeature(feature){
            var json = 'Economics.json';
            var MinValue;
            var MaxValue;
            var attribution = optionsAttr.options[optionsAttr.selectedIndex].value;
            var attr_value = [];
            var colorFill = [];
            d3.json(json, function(error, json){
                data = json;

                for (i=0 ; i<json.features.length; i++){
                    attr_value[i] = json.features[i].properties[attribution];
                }

                MinValue = d3.min(attr_value);
                MaxValue = d3.max(attr_value);
            });

                var low = [5, 69, 54];
                var high = [151, 83, 34];
                var delta = (feature.getProperty(attribution) - MinValue)/ (MaxValue - MinValue);
                for (var i = 0; i < 3; i++){
                    colorFill[i] = (high[i] - low[i]) * delta + low[i];
                }
                return ({
                    fillColor: 'hsl(' + colorFill[0] + ',' + colorFill[1] + '%,' + colorFill[2] + '%)',
                    strokeWeight: 1.2,
                    fillOpacity: 0.8,
                    strokeColor: '#fff'

                })
        }

        // Change Attribute
        function changeAttribute(){
            var optionsAttr = document.getElementById('census-variable');
            return optionsAttr.options[optionsAttr.selectedIndex].value;
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAwliwbM5L67cRMDQhOYNEeR3a5Sv1gIOk&callback=myMap"></script>
</body>
</html>